# Container recipe

# NOTE: this definition file depends on features only available in
# Singularity 3.2 and later.
BootStrap: localimage
From: mpi.sif
Stage: devel
%post
    . /.singularity.d/env/10-docker*.sh

# FFTW version 3.3.10
%post
    apt-get update -y
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        file \
        make \
        wget
    rm -rf /var/lib/apt/lists/*
%post
    cd /
    mkdir -p /var/tmp && wget -q -nc --no-check-certificate -P /var/tmp ftp://ftp.fftw.org/pub/fftw/fftw-3.3.10.tar.gz
    mkdir -p /var/tmp && tar -x -f /var/tmp/fftw-3.3.10.tar.gz -C /var/tmp -z
    cd /var/tmp/fftw-3.3.10 &&   ./configure --prefix=/usr/local/fftw --enable-mpi --enable-openmp
    make -j$(nproc)
    make -j$(nproc) install
    rm -rf /var/tmp/fftw-3.3.10 /var/tmp/fftw-3.3.10.tar.gz
%environment
    export LD_LIBRARY_PATH=/usr/local/fftw/lib:$LD_LIBRARY_PATH
%post
    export LD_LIBRARY_PATH=/usr/local/fftw/lib:$LD_LIBRARY_PATH

%environment
    export CPATH=/usr/local/fftw/include:$CPATH
    export CPLUS_INCLUDE_PATH=/usr/local/fftw/include:$CPLUS_INCLUDE_PATH
    export C_INCLUDE_PATH=/usr/local/fftw/include:$C_INCLUDE_PATH
    export LIBRARY_PATH=/usr/local/fftw/lib:$LIBRARY_PATH
%post
    export CPATH=/usr/local/fftw/include:$CPATH
    export CPLUS_INCLUDE_PATH=/usr/local/fftw/include:$CPLUS_INCLUDE_PATH
    export C_INCLUDE_PATH=/usr/local/fftw/include:$C_INCLUDE_PATH
    export LIBRARY_PATH=/usr/local/fftw/lib:$LIBRARY_PATH

%environment
    export CUDA_PATH=/usr/local/cuda-12.6
%post
    export CUDA_PATH=/usr/local/cuda-12.6

%post
    cd /
    mkdir -p /opt && cd /opt && git clone --recursive https://bitbucket.org/nschaeff/xshells.git xshells && cd - && cd /opt/xshells && git checkout 1ba7e6aa2ab7ddeae8a9f431acb3c9a1da0bbc11 && cd -

%files
    ./xshells.hpp /opt/xshells.hpp

%post
    cd /
    mv /opt/xshells.hpp /opt/xshells
    cd /opt/xshells
    ./configure MPICXX=mpicxx --enable-cuda=ampere
    make xsgpu_mpi

%environment
    export PATH=/opt/xshells:$PATH
%post
    export PATH=/opt/xshells:$PATH

